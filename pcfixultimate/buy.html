<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PCFixUltimate — شراء/تفعيل (وضع الاختبار)</title>
<style>
  :root{
    --bg:#0b0f16; --panel:#0f172a; --muted:#93a3b8; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --brand:#3b82f6;
    --txt:#e5eefc; --txt2:#c9d4e5; --card:#0b1324; --border:#1f2937;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b0f16,#0b1120);color:var(--txt);font:15px/1.6 system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:980px;margin:34px auto;padding:0 16px}
  .hero{display:flex;gap:12px;align-items:center;background:radial-gradient(900px 500px at 110% -60%, rgba(59,130,246,.18),transparent),
                                radial-gradient(900px 500px at -10% 120%, rgba(16,185,129,.12),transparent);
        border:1px solid var(--border);border-radius:18px;padding:18px}
  .logo{font-weight:900;font-size:26px;letter-spacing:.2px}
  .tag{font-size:12px;color:var(--txt2);background:#0b1324;border:1px solid var(--border);padding:4px 10px;border-radius:999px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:18px}
  @media (max-width: 880px){ .row{grid-template-columns:1fr} }
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px}
  h2{margin:0 0 10px 0;font-size:18px}
  .muted{color:var(--muted);font-size:13px}
  .input{display:flex;gap:8px;align-items:center;margin-top:10px}
  input[type=text]{flex:1;background:var(--card);border:1px solid var(--border);border-radius:10px;color:var(--txt);padding:10px 12px;direction:ltr}
  button{background:var(--brand);border:none;color:white;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
  button.secondary{background:#172033;color:var(--txt2);border:1px solid var(--border)}
  button.ghost{background:#0f172a;color:var(--txt2);border:1px dashed #2a3a55}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  .pill{background:#0b1324;border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-family:ui-monospace,Consolas}
  .flex{display:flex;gap:10px;align-items:center}
  .divider{height:1px;background:var(--border);margin:14px 0}
  .hidden{display:none}
  .success{background:rgba(16,185,129,.09);border:1px solid rgba(16,185,129,.35);padding:12px;border-radius:12px;color:#d1fae5}
  .danger{background:rgba(239,68,68,.09);border:1px solid rgba(239,68,68,.35);padding:12px;border-radius:12px;color:#fee2e2}
  .foot{margin-top:12px;color:var(--muted);font-size:12px}
  .grid2{display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:center}
</style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div class="logo">PCFixUltimate</div>
      <span class="tag">وضع الاختبار — توليد أكواد للمستخدم</span>
      <div style="flex:1"></div>
      <button class="ghost" id="how">كيف تعمل الصفحة؟</button>
    </div>

    <div class="row">
      <!-- بصمة الجهاز -->
      <div class="card">
        <h2>١) بصمة الجهاز (Machine Fingerprint)</h2>
        <div class="muted">يجب أن يفتح التطبيق هذه الصفحة ويمرّر <b>mh</b> تلقائيًا. إن لم تظهر، الصِقها يدويًا أو اضغط “لصق”.</div>
        <div class="input">
          <input id="mh" type="text" placeholder="machine_hash (من التطبيق)" />
          <button class="secondary" id="pasteMH">لصق</button>
        </div>
        <div class="grid2" style="margin-top:10px">
          <div class="pill"><b>حالة البصمة:</b> <span id="mhStatus" class="warn">مفقودة</span></div>
          <div class="pill" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
            <b>واجهة الـ API:</b>
            <span id="apiShown" style="direction:ltr">—</span>
          </div>
        </div>
        <div class="divider"></div>
        <div class="muted">
          تلميح: يفتح التطبيق الصفحة مثلًا: <br />
          <code style="direction:ltr">https://…/buy.html?mh=&lt;hash&gt;</code>
        </div>
      </div>

      <!-- الإصدار والتحميل -->
      <div class="card">
        <h2>٢) آخر إصدار</h2>
        <div id="verBox" class="muted">جاري جلب معلومات آخر إصدار…</div>
        <div id="dlBox" class="hidden" style="margin-top:10px">
          <div class="flex">
            <div class="pill"><b>الإصدار:</b> <span id="verText">—</span></div>
            <a id="dlBtn" class="pill" href="#" download>⬇ تحميل آخر إصدار</a>
          </div>
          <div class="foot">يُنصح بالتحميل ثم التفعيل بالكود القصير بعد الدفع التجريبي.</div>
        </div>
      </div>
    </div>

    <!-- الدفع التجريبي -->
    <div class="card" style="margin-top:18px">
      <h2>٣) محاكاة الدفع (وهمي)</h2>
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="eula" />
        <span>أوافق على اتفاقية الترخيص وشروط الاستخدام.</span>
      </label>
      <div class="input" style="margin-top:10px">
        <button id="pay" disabled>إكمال الدفع التجريبي</button>
        <button id="reset" class="secondary">إعادة تعيين</button>
      </div>
      <div id="payMsg" style="margin-top:10px" class="muted"></div>
    </div>

    <!-- النتائج -->
    <div class="card" style="margin-top:18px">
      <h2>٤) كود التفعيل الخاص بالمستخدم</h2>
      <div id="okBox" class="success hidden">تمت محاكاة الدفع — الكود جاهز للاستخدام.</div>
      <div id="errBox" class="danger hidden"></div>
      <div id="resultBox" class="hidden">
        <div class="flex">
          <div style="min-width:170px">الكود القصير (انسخه للمستخدم):</div>
          <div id="pretty" class="pill" style="direction:ltr">—</div>
          <button class="secondary" id="copyPretty">نسخ</button>
        </div>
        <div class="divider"></div>
        <div class="muted">
          داخل التطبيق → <b>تفعيل</b>: الصق الكود القصير فقط (يحوّله التطبيق تلقائيًا إلى رخصة عبر الخادم).
        </div>
      </div>
    </div>

    <div class="foot">© PCFixUltimate — هذه الصفحة لا تُجري دفعات حقيقية؛ الهدف اختبار توليد الأكواد المرتبطة بالجهاز.</div>
  </div>

<script>
  // ------- إعدادات -------
  const API_GENERATE = "https://pcfix-license-api.pcfixultimate.workers.dev/generate";
  const LATEST_JSON  = "https://ameero197-dotcom.github.io/pcfixultimate/latest.json";

  // عناصر
  const $ = (id)=>document.getElementById(id);
  const mhInput   = $("mh");
  const mhStatus  = $("mhStatus");
  const eula      = $("eula");
  const payBtn    = $("pay");
  const resetBtn  = $("reset");
  const payMsg    = $("payMsg");
  const okBox     = $("okBox");
  const errBox    = $("errBox");
  const resultBox = $("resultBox");
  const prettyEl  = $("pretty");
  const copyPretty= $("copyPretty");
  const apiShown  = $("apiShown");
  const verBox    = $("verBox");
  const dlBox     = $("dlBox");
  const verText   = $("verText");
  const dlBtn     = $("dlBtn");

  apiShown.textContent = API_GENERATE;

  // جلب آخر إصدار
  async function loadLatest(){
    try{
      const res = await fetch(LATEST_JSON, { cache: "no-store" });
      if(!res.ok) throw new Error("تعذّر جلب latest.json");
      const j = await res.json();
      verText.textContent = j.version || "—";
      dlBtn.href = j.url || "#";
      dlBtn.classList.remove("secondary");
      verBox.innerHTML = `<span class="ok">✔</span> تم جلب بيانات الإصدار.`;
      dlBox.classList.remove("hidden");
    }catch(err){
      verBox.innerHTML = `<span class="err">⚠</span> فشل جلب معلومات الإصدار: ${err.message||err}`;
    }
  }

  // تهيئة من الـ query
  const q = new URLSearchParams(location.search);
  mhInput.value = q.get("mh") || q.get("machine_hash") || "";
  function refreshMH(){
    if (mhInput.value.trim()){
      mhStatus.textContent = "جاهزة"; mhStatus.className = "ok";
    } else {
      mhStatus.textContent = "مفقودة"; mhStatus.className = "warn";
    }
    refreshPayState();
  }
  function refreshPayState(){
    payBtn.disabled = !(eula.checked && mhInput.value.trim());
  }
  eula.addEventListener("change", refreshPayState);
  mhInput.addEventListener("input", refreshMH);
  $("pasteMH").addEventListener("click", async ()=>{
    try{
      const t = await navigator.clipboard.readText();
      if(t){ mhInput.value = t.trim(); refreshMH(); }
    }catch{}
  });
  $("how").addEventListener("click",(e)=>{
    e.preventDefault();
    alert("الخطوات:\n• الصق بصمة الجهاز (mh) إن لم تُمرَّر تلقائيًا.\n• وافق على الشروط ثم اضغط إكمال الدفع التجريبي.\n• ستتلقى الكود القصير المخصص لهذا الجهاز.\n• داخل التطبيق، الصق الكود القصير فقط في نافذة التفعيل.");
  });

  // نداء /generate (POST) — الخادم جهّزناه لدعم POST/GET
  async function callGenerate(api, mh){
    const res = await fetch(api, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ mh })
    });
    if(!res.ok){
      const txt = await res.text().catch(()=>res.statusText);
      throw new Error(`API ${res.status}: ${txt}`);
    }
    return res.json();
  }

  function showError(msg){
    errBox.textContent = msg;
    errBox.classList.remove("hidden");
    okBox.classList.add("hidden");
    resultBox.classList.add("hidden");
    payMsg.textContent = "";
  }
  function showResult(shortCode){
    prettyEl.textContent = shortCode || "—";
    errBox.classList.add("hidden");
    okBox.classList.remove("hidden");
    resultBox.classList.remove("hidden");
    payMsg.innerHTML = '<span class="ok">✔</span> تمت محاكاة الدفع بنجاح.';
  }

  payBtn.addEventListener("click", async ()=>{
    payBtn.disabled = true;
    payMsg.textContent = "جارٍ المعالجة…";
    errBox.classList.add("hidden");
    okBox.classList.add("hidden");
    resultBox.classList.add("hidden");
    try{
      const mh = mhInput.value.trim();
      if(!mh) return showError("الرجاء إدخال بصمة الجهاز (mh).");
      const data = await callGenerate(API_GENERATE, mh);
      if(!data || !data.short_code){
        return showError("استجابة غير متوقعة من الخادم: لم يتم العثور على short_code.");
      }
      showResult(data.short_code);
    }catch(err){
      showError(err.message || String(err));
    }finally{
      refreshPayState();
    }
  });

  resetBtn.addEventListener("click", ()=>{
    eula.checked = false;
    payMsg.textContent = "";
    okBox.classList.add("hidden");
    errBox.classList.add("hidden");
    resultBox.classList.add("hidden");
    refreshPayState();
  });

  copyPretty.addEventListener("click", ()=>{
    const t = prettyEl.textContent || "";
    try{ navigator.clipboard.writeText(t); payMsg.innerHTML = '<span class="ok">✔</span> تم النسخ.'; }catch{}
  });

  // تهيئة أولية
  refreshMH();
  loadLatest();
</script>
</body>
</html>
