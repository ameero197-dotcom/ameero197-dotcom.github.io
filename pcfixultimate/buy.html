<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <title>PCFixUltimate — شراء/تفعيل</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body{font-family:system-ui,Segoe UI,Arial,sans-serif;max-width:800px;margin:24px auto;padding:0 12px;line-height:1.6}
      .card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin:12px 0}
      .row{display:flex;gap:8px;align-items:center}
      input[type="text"], textarea{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;direction:ltr}
      button{padding:10px 14px;border-radius:10px;border:0;background:#1A73E8;color:#fff;font-weight:600;cursor:pointer}
      button.secondary{background:#10b981}
      small{color:#6b7280}
      .muted{color:#6b7280}
      .hidden{display:none}
      .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    </style>
  </head>
  <body>
    <h1>PCFixUltimate — شراء/تفعيل</h1>
    <p class="muted">
      هذه الصفحة تولّد ترخيصًا مرتبطًا بجهازك باستخدام بصمة الجهاز (<span class="mono">machine hash</span>).
    </p>

    <div class="card">
      <form id="form" class="row" autocomplete="off">
        <input id="mh_input" type="text" placeholder="الصق machine hash هنا إن لم يُمرَّر في رابط الصفحة" />
        <button type="submit">توليد الترخيص</button>
      </form>
      <small>إذا فتحت الصفحة من البرنامج سيتم تمرير <span class="mono">mh</span> تلقائيًا في رابط الصفحة.</small>
    </div>

    <div class="card">
      <div>Machine hash: <span id="mh" class="mono">—</span></div>
      <div id="status" style="margin-top:8px" class="muted">جاهز</div>
    </div>

    <div id="result" class="card hidden">
      <label>Short code (المُفضّل للصق داخل البرنامج):</label>
      <div class="row">
        <input id="short" type="text" readonly />
        <button type="button" onclick="copy('short')">نسخ</button>
      </div>
      <small>يبدأ بـ <span class="mono">PCFX-</span> ويمكن تبادله داخل البرنامج عبر الإنترنت.</small>

      <hr />

      <label>Activation code (خام بصيغة <span class="mono">licenseId.signature</span>):</label>
      <div class="row">
        <input id="activation" type="text" readonly />
        <button type="button" class="secondary" onclick="copy('activation')">نسخ</button>
      </div>

      <hr />

      <label>JWT (للاستخدام المتقدم/أوفلاين):</label>
      <div class="row">
        <textarea id="token" rows="4" readonly></textarea>
        <button type="button" onclick="copy('token')">نسخ</button>
      </div>
    </div>

    <script>
      const API = "https://pcfix-license-api.pcfixultimate.workers.dev";
      const $ = (id) => document.getElementById(id);

      async function generateFor(mh){
        $("mh").textContent = mh || "—";
        $("status").textContent = "جاري التوليد...";
        try{
          const res = await fetch(`${API}/generate?mh=${encodeURIComponent(mh)}`);
          const data = await res.json();
          if(!res.ok) throw new Error(data?.error || res.statusText);

          $("token").value = data.token || "";
          $("activation").value = data.activation_code || "";
          $("short").value = data.short_code || "";

          $("result").classList.remove("hidden");
          $("status").textContent = "تم التوليد ✓";
        }catch(err){
          $("status").textContent = "خطأ: " + err.message;
          $("result").classList.add("hidden");
        }
      }

      function copy(id){
        const val = $(id).value || "";
        navigator.clipboard.writeText(val).then(()=>{
          $("status").textContent = "تم النسخ ✓";
        }).catch(err=>{
          $("status").textContent = "تعذّر النسخ: " + err.message;
        });
      }

      document.addEventListener("DOMContentLoaded", ()=>{
        const params = new URLSearchParams(location.search);
        const mh = params.get("mh") || params.get("machine_hash") || "";
        if (mh) {
          $("mh_input").value = mh;
          generateFor(mh);
        }
        $("form").addEventListener("submit", (e)=>{
          e.preventDefault();
          const input = $("mh_input").value.trim();
          if (input) generateFor(input);
        });
      });
    </script>
    <!-- ملاحظات تقنية:
      - قراءة mh من URL تتم عبر URLSearchParams.
      - الطلب يتم عبر fetch (GET) مع CORS.
      - النسخ يستخدم Clipboard API writeText().
    -->
  </body>
</html>
