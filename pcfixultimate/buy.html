<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PCFixUltimate — شراء تجريبي (كود قصير)</title>
  <style>
    :root{
      --bg:#070b12; --panel:#0f1724; --muted:#9aa4b2; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --brand:#3b82f6;
      --txt:#e6eef6; --txt2:#c7d3df; --border:rgba(255,255,255,.06); --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Roboto Mono", monospace;
      --shadow: 0 10px 30px rgba(2,6,23,.55);
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:linear-gradient(180deg,#060910,#0a1320);color:var(--txt);
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
      font:15px/1.5 system-ui, "Segoe UI", Roboto, Arial; padding:28px;
    }
    .wrap{max-width:980px;margin:0 auto}
    .hero{display:flex;gap:12px;align-items:center;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px 16px;box-shadow:var(--shadow)}
    .logo{font-weight:800;font-size:22px;letter-spacing:.5px}
    .tag{font-size:12px;color:var(--txt2);background:rgba(255,255,255,.04);padding:6px 10px;border-radius:999px;border:1px solid var(--border)}
    .grid{display:grid;grid-template-columns:1.25fr .75fr;gap:16px;margin-top:14px}
    @media(max-width:980px){ .grid{grid-template-columns:1fr} }
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:var(--shadow)}
    h2{margin:0 0 8px 0;font-size:16px}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:8px;align-items:center}
    .input{flex:1;background:#0a1220;border:1px solid var(--border);border-radius:10px;color:var(--txt);padding:10px 12px}
    button{
      background:linear-gradient(180deg,var(--brand),#2563eb);border:none;color:#fff;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer
    }
    button.secondary{background:transparent;border:1px solid var(--border);color:var(--txt2);font-weight:600}
    button.ghost{background:transparent;border:1px dashed var(--border);color:var(--txt2)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .pill{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-family:var(--mono);font-size:13px;word-break:break-all}
    .code-big{font-family:var(--mono);font-size:20px;letter-spacing:.6px}
    .divider{height:1px;background:var(--border);margin:12px 0;border-radius:4px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .note{background:rgba(255,255,255,.02);border:1px dashed var(--border);padding:10px;border-radius:10px;color:var(--txt2);font-size:13px}
    .status{font-size:13px;margin-top:8px}
    .ver{font-weight:800}
    .flex{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div class="logo">PCFixUltimate</div>
      <span class="tag">اختبار قبل الإطلاق — كود قصير فقط</span>
      <div style="flex:1"></div>
      <button class="ghost" id="helpBtn">كيف يعمل؟</button>
    </div>

    <div class="grid">
      <!-- العمود الأيسر: البصمة + الدفع الوهمي + الكود -->
      <div class="card">
        <h2>1) بصمة الجهاز</h2>
        <div class="muted">عادةً يفتح التطبيق هذه الصفحة ومعه <code>?mh=&lt;machine_hash&gt;</code>. يمكنك لصقها يدويًا.</div>
        <div class="row" style="margin-top:10px">
          <input id="mh" class="input" type="text" placeholder="machine_hash من التطبيق" />
          <button id="pasteMH" class="secondary">لصق</button>
        </div>
        <div class="row status">
          <div>الحالة: <span id="mhStatus" class="warn">مفقودة</span></div>
          <div style="flex:1"></div>
          <div class="muted">المضيف: <span id="host">—</span></div>
        </div>

        <div class="divider"></div>

        <h2>2) دفع وهمي</h2>
        <div class="muted">لا يوجد تحصيل فعلي — عند النجاح سنولّد الكود القصير لهذا الجهاز.</div>
        <label class="row" style="margin-top:8px">
          <input id="agree" type="checkbox" style="transform:scale(1.2);margin-left:6px" />
          <span class="muted">أوافق على بنود الاستخدام (اختبار)</span>
        </label>
        <div class="row" style="margin-top:10px">
          <input id="api" class="input" type="url" placeholder="رابط /generate" />
          <button id="pay" disabled>إكمال الدفع التجريبي</button>
        </div>
        <div id="payMsg" class="status muted"></div>
        <div id="err" class="status err"></div>

        <div class="divider"></div>

        <h2>3) كودك القصير</h2>
        <div id="emptyBox" class="note">لم يتم توليد أي كود بعد.</div>
        <div id="codeBox" class="row" style="margin-top:8px;display:none">
          <div id="shortCode" class="pill code-big" style="flex:1">—</div>
          <button id="copyShort" class="secondary">نسخ</button>
        </div>
      </div>

      <!-- العمود الأيمن: تنزيل آخر إصدار -->
      <div class="card">
        <h2>أحدث إصدار من البرنامج</h2>
        <div class="muted">حمّل آخر نسخة من المُثبّت لتجاربك على الأجهزة.</div>

        <div class="row" style="margin-top:10px">
          <div class="pill" style="flex:1">الإصدار: <span id="ver" class="ver">—</span></div>
          <a id="dl" class="row" href="#" target="_blank" rel="noopener">
            <button id="dlBtn">تحميل المُثبّت</button>
          </a>
        </div>

        <div class="divider"></div>

        <h2>إعدادات متقدمة (اختياري)</h2>
        <div class="note">
          يمكن تمرير بارامترات في رابط الصفحة:<br/>
          <code>?mh=...&amp;api=...&amp;repo=owner/repo&amp;download=...&amp;ver=...</code>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========= عناصر واجهة =========
    const $ = (id)=>document.getElementById(id);
    const q = new URLSearchParams(location.search);
    const state = { shortCode: "", downloadURL: "", version: "" };

    // ========= تهيئة الحقول =========
    const defaultAPI = "https://pcfix-license-api.pcfixultimate.workers.dev/generate";
    $("api").value = q.get("api") || defaultAPI;
    $("mh").value  = (q.get("mh") || q.get("machine_hash") || "").trim();
    $("host").textContent = location.host || "—";
    $("mhStatus").textContent = $("mh").value ? "موجودة" : "مفقودة";
    $("mhStatus").className  = $("mh").value ? "ok" : "warn";

    function refreshPayState(){
      $("pay").disabled = !( $("agree").checked && $("mh").value.trim() && $("api").value.trim() );
    }
    $("agree").addEventListener("change", refreshPayState);
    $("mh").addEventListener("input", ()=>{ $("mhStatus").textContent = $("mh").value ? "موجودة":"مفقودة"; refreshPayState(); });
    $("api").addEventListener("input", refreshPayState);
    refreshPayState();

    $("pasteMH").addEventListener("click", async ()=>{
      try{
        const t = await navigator.clipboard.readText();
        if(t){ $("mh").value = t.trim(); $("mhStatus").textContent = "موجودة"; refreshPayState(); }
      }catch{}
    });

    $("helpBtn").addEventListener("click", (e)=>{
      e.preventDefault();
      alert(
`الخطوات (اختبار):
1) أدخل بصمة الجهاز mh (أو افتح الصفحة مع ?mh=...).
2) وافق على الشروط واضغط "إكمال الدفع التجريبي".
3) سيستدعي المتصفح /generate عبر POST ويرجع الكود القصير (PCFX-…).
4) انسخ الكود والصقه في التطبيق المُثبّت لتجربة التفعيل.`
      );
    });

    // ========= تحميل آخر إصدار =========
    async function setDownload({version, url}){
      state.version = version || "—";
      state.downloadURL = url || "#";
      $("ver").textContent = state.version;
      $("dl").href = state.downloadURL;
      $("dlBtn").disabled = !url;
    }

    async function loadLatest(){
      const ver = q.get("ver");
      const direct = q.get("download");
      const repo = q.get("repo"); // owner/repo

      if (ver && direct){
        return setDownload({version: ver, url: direct});
      }

      if (repo){
        try{
          const api = `https://api.github.com/repos/${repo}/releases/latest`;
          const res = await fetch(api, {
            headers: {
              "Accept":"application/vnd.github+json",
              "X-GitHub-Api-Version":"2022-11-28"
            }
          });
          if (res.ok){
            const j = await res.json();
            const tag = j.tag_name || j.name || "latest";
            const asset = (j.assets||[]).find(a => /\.exe$/i.test(a.name)) || (j.assets||[])[0];
            const url = asset ? asset.browser_download_url : (j.html_url || "");
            return setDownload({version: tag, url});
          }
        }catch(e){}
      }

      // fallback — لو لم تتوفر معلومات
      return setDownload({version: "—", url: ""});
    }
    loadLatest();

    // ========= نداء /generate (POST) =========
    async function callGenerate(api, mh){
      const res = await fetch(api, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ mh })
      });
      if(!res.ok){
        const txt = await res.text().catch(()=>res.statusText);
        throw new Error(`API ${res.status} — ${txt}`);
      }
      return res.json();
    }

    function showShort(code){
      state.shortCode = code || "—";
      $("shortCode").textContent = state.shortCode;
      $("emptyBox").style.display = "none";
      $("codeBox").style.display = "flex";
    }

    $("copyShort").addEventListener("click", async ()=>{
      try{ await navigator.clipboard.writeText(state.shortCode); $("payMsg").textContent = "تم النسخ ✓"; }
      catch{ $("payMsg").textContent = "تعذّر النسخ"; }
    });

    $("pay").addEventListener("click", async ()=>{
      $("err").textContent = "";
      $("payMsg").textContent = "جارٍ المعالجة…";
      $("pay").disabled = true;
      try{
        const api = $("api").value.trim();
        const mh  = $("mh").value.trim();
        if(!api || !mh) throw new Error("مفقود: API أو mh");

        const data = await callGenerate(api, mh);
        const pretty = data.short_code || data.activation_code_pretty;
        if(!pretty) throw new Error("استجابة غير متوقعة: لم تُعد short_code");

        showShort(pretty);
        $("payMsg").textContent = "تمت المحاكاة بنجاح — الكود جاهز.";
      }catch(err){
        $("err").textContent = (err && err.message) ? err.message : String(err);
        $("payMsg").textContent = "";
      }finally{
        refreshPayState();
      }
    });
  </script>
</body>
</html>
