<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PCFixUltimate – Generate License</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0a0a0a;color:#eee;margin:0;padding:24px}
    .card{max-width:760px;margin:0 auto;background:#141414;border:1px solid #1f1f1f;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.4);padding:24px}
    h1{margin:0 0 8px}
    .muted{color:#9aa0a6;font-size:14px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    input,button,textarea{border-radius:8px;border:1px solid #2a2a2a;background:#0a0a0a;color:#eee;padding:10px 12px}
    input[readonly],textarea{width:100%;font-family:ui-monospace,Consolas,monospace}
    button{cursor:pointer}
    .out{margin-top:18px;padding:12px;background:#0f0f0f;border:1px solid #232323;border-radius:10px}
    .label{font-size:12px;color:#aab0b5;margin-bottom:6px}
    .grid{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    .ok{color:#9be49d}
    .err{color:#ff8a8a}
    .small{font-size:12px;color:#aab0b5}
  </style>
</head>
<body>
  <div class="card">
    <h1>PCFixUltimate — Generate Codes</h1>
    <div class="muted">هذه الصفحة تولّد لك الأكواد بناءً على بصمة جهازك (machine hash) القادمة من التطبيق.</div>

    <div class="row">
      <div style="flex:1 1 320px">
        <div class="label">Machine Hash (mh)</div>
        <input id="mh" readonly />
      </div>
      <div>
        <div class="label">&nbsp;</div>
        <button id="gen">Generate</button>
      </div>
    </div>

    <div id="status" class="small" style="margin-top:10px"></div>

    <div class="out" id="out" style="display:none">
      <div class="grid">
        <div>
          <div class="label">Short Code (يوضع داخل البرنامج مباشرة)</div>
          <input id="short" readonly />
        </div>
        <button data-copy="#short">Copy</button>
      </div>

      <div class="grid">
        <div>
          <div class="label">Activation Code (raw)</div>
          <input id="raw" readonly />
        </div>
        <button data-copy="#raw">Copy</button>
      </div>

      <details style="margin-top:8px">
        <summary>JWT (للمراجعة فقط)</summary>
        <textarea id="jwt" rows="6" readonly></textarea>
      </details>
    </div>
  </div>

  <script>
    const API = "https://pcfix-license-api.pcfixultimate.workers.dev";

    const qs = new URLSearchParams(location.search);
    const mh = (qs.get("mh") || qs.get("machine_hash") || "").trim();
    const $ = sel => document.querySelector(sel);

    $("#mh").value = mh || "(missing)";
    $("#status").textContent = mh ? "جاهز للتوليد." : "⚠️ لا يوجد mh في رابط الصفحة.";

    document.getElementById("gen").onclick = async () => {
      if (!mh) { $("#status").textContent = "أدخل من التطبيق ليجي mh تلقائي."; return; }
      $("#status").textContent = "جارٍ التوليد...";
      try {
        const r = await fetch(`${API}/generate`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ mh })
        });
        const data = await r.json();
        if (!r.ok) throw new Error(data?.error || r.statusText);

        $("#short").value = data.short_code || "";
        $("#raw").value   = data.activation_code || "";
        $("#jwt").value   = data.token || "";
        $("#out").style.display = "block";
        $("#status").textContent = "✓ تم التوليد بنجاح. انسخ الـ Short Code وألصقه في البرنامج.";
        $("#status").className = "ok";
      } catch (e) {
        $("#status").textContent = "خطأ: " + e.message;
        $("#status").className = "err";
      }
    };

    document.addEventListener("click", (e)=>{
      const btn = e.target.closest("[data-copy]");
      if (!btn) return;
      const input = document.querySelector(btn.getAttribute("data-copy"));
      input.select(); input.setSelectionRange(0, 99999);
      document.execCommand("copy");
      btn.textContent = "Copied!";
      setTimeout(()=> btn.textContent = "Copy", 1200);
    });
  </script>
  <noscript>JavaScript مطلوب.</noscript>
</body>
</html>
