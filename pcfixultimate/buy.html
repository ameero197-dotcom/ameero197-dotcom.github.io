<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PCFixUltimate ‚Äî Purchase & License</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="./pcfix_icon.ico">
  <style>
    :root{--bg:#0b1020;--card:#111a33;--txt:#e8ecf3;--muted:#a9b3c3;--accent:#4aa8ff;--ok:#31d0a0;--warn:#ffb020;--err:#ff6b6b;}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:860px;margin:40px auto;padding:24px}
    .card{background:var(--card);border:1px solid #1d2a4f;border-radius:18px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{margin:0 0 8px}
    p{margin:8px 0;color:var(--muted)}
    .row{display:flex;flex-wrap:wrap;gap:12px;margin-top:14px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:none;border-radius:12px;padding:12px 16px;
         background:linear-gradient(180deg,#3aa0ff,#1f7fe0);color:#fff;font-weight:600;text-decoration:none;cursor:pointer}
    .btn.secondary{background:#243355;border:1px solid #2b4477}
    .btn.ok{background:linear-gradient(180deg,#44d8ae,#23b389)}
    code{background:#0d1530;border:1px solid #1d2a4f;border-radius:8px;padding:6px 8px}
    .mono{font-family:ui-monospace,SFMono-Regular,Consolas,Monaco,monospace;word-break:break-all}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:16px}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
    .note{font-size:13px;color:#b8c4dd}
    .tag{display:inline-block;background:#203055;border:1px solid #2b4477;color:#bcd0ff;padding:6px 10px;border-radius:999px;font-size:12px}
    .box{background:#0c1634;border:1px dashed #27407b;padding:12px;border-radius:12px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>PCFixUltimate ‚Äî Purchase & License</h1>
    <p>Download the latest installer and activate your license for this machine.</p>

    <div class="row">
      <a id="downloadBtn" class="btn secondary" href="#" download>‚¨áÔ∏è Download Latest Setup</a>
      <a class="btn" href="./index.html" target="_self">‚ÑπÔ∏è See releases page</a>
      <span id="verTag" class="tag">Loading‚Ä¶</span>
    </div>

    <div class="grid">
      <div>
        <h3>Step 1 ‚Äî Confirm machine hash</h3>
        <p class="note">Your machine hash (passed in URL):</p>
        <p class="mono" id="mhBox">‚Äî</p>
        <div class="box note">
          If this value is empty or not your device, re-open the app‚Äôs ‚ÄúBuy‚Äù page so it passes the correct machine hash.
        </div>
      </div>
      <div>
        <h3>Step 2 ‚Äî Purchase</h3>
        <p class="note">For now, this is a placeholder. Connect your real checkout later.</p>
        <div class="row">
          <button id="payMock" class="btn">üí≥ Mock Purchase (dev)</button>
        </div>
        <p class="note">After real payment, you‚Äôll auto-generate the license for this machine.</p>
      </div>
    </div>

    <h3 style="margin-top:22px">Step 3 ‚Äî Generate license</h3>
    <div class="row">
      <button id="genBtn" class="btn ok" disabled>üîê Generate Lifetime License</button>
      <span id="genStatus" class="note">Complete purchase to enable.</span>
    </div>
    <div id="licenseWrap" style="display:none;margin-top:12px">
      <p class="note">Your license token:</p>
      <pre class="mono" id="tokenBox" style="white-space:pre-wrap"></pre>
    </div>

    <h3 style="margin-top:22px">Integrity</h3>
    <p class="note">Expected SHA-256:</p>
    <p class="mono" id="shaBox">‚Äî</p>
  </div>
</div>

<script>
(async () => {
  // 1) Read query params
  const qs = new URLSearchParams(location.search);
  const mh  = qs.get("mh")  || "";
  const api = qs.get("api") || "https://pcfix-license-api.pcfixultimate.workers.dev/generate";

  // Show machine hash
  document.getElementById("mhBox").textContent = mh ? mh : "(missing)";

  // 2) Load latest.json for download + SHA + version tag
  const verTag = document.getElementById("verTag");
  const dlBtn  = document.getElementById("downloadBtn");
  const shaBox = document.getElementById("shaBox");
  try {
    const r = await fetch("./latest.json", {cache:"no-store"});
    if (!r.ok) throw new Error("latest.json not found");
    const j = await r.json();
    const version = String(j.version || "‚Äî");
    const url     = String(j.url || "");
    const sha     = String(j.sha256 || "‚Äî");
    verTag.textContent = "v" + version;
    shaBox.textContent = sha;
    if (url) {
      dlBtn.href = url;
      dlBtn.download = `PCFixUltimateSetup_${version}.exe`;
    } else {
      dlBtn.classList.remove("secondary");
      dlBtn.textContent = "No download available";
      dlBtn.removeAttribute("href");
    }
  } catch(e) {
    verTag.textContent = "Error";
    console.error(e);
  }

  // 3) Mock purchase flow (DEV): toggles a flag
  const payMock = document.getElementById("payMock");
  const genBtn  = document.getElementById("genBtn");
  const genStatus = document.getElementById("genStatus");
  let canGenerate = false;

  function enableGenerate() {
    canGenerate = true;
    genBtn.disabled = false;
    genStatus.textContent = "Ready. Click to generate license.";
  }

  // If you integrate real checkout, redirect back with ?paid=1
  if (qs.get("paid") === "1") enableGenerate();

  payMock.addEventListener("click", () => {
    // In production, replace this with your real checkout ‚Üí redirect back with ?paid=1
    enableGenerate();
  });

  // 4) Generate license via Worker
  const tokenBox = document.getElementById("tokenBox");
  const licenseWrap = document.getElementById("licenseWrap");
  genBtn.addEventListener("click", async () => {
    if (!canGenerate) return;
    if (!mh) { alert("Missing machine hash in URL (?mh=...)"); return; }
    genBtn.disabled = true;
    genStatus.textContent = "Generating...";
    try {
      const u = new URL(api);
      u.searchParams.set("mh", mh);
      const r = await fetch(u.toString(), {method:"GET"});
      if (!r.ok) throw new Error("Generate failed: " + r.status);
      const data = await r.json();
      if (!data.token) throw new Error("No token field in response");
      tokenBox.textContent = data.token;
      licenseWrap.style.display = "block";
      genStatus.textContent = "Done ‚úî";
    } catch (e) {
      genStatus.textContent = "Failed";
      alert(e.message || String(e));
    } finally {
      genBtn.disabled = false;
    }
  });
})();
</script>
</body>
</html>
