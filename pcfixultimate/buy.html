<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <title>PCFixUltimate — شراء وتفعيل النسخة الكاملة</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- PayPal JS SDK (Buttons) - LIVE -->
    <!-- ملاحظة: لا تضع client secret هنا أبداً، فقط client-id -->
    <script
      src="https://www.paypal.com/sdk/js?client-id=AfihjAXTyDN5TqjgromFKBgDJb13HTB4SqlvZ9JusszBMBLCUxVJKBA8jz-ThHzl5Lhslp4rEvv-_Enc&currency=USD&intent=capture&components=buttons"
      data-sdk-integration-source="button-factory">
    </script>

    <style>
      :root{
        --bg:#020617;
        --card:#020617;
        --border:#1f2937;
        --accent:#2563eb;
        --accent-soft:rgba(37,99,235,.25);
        --accent-strong:#1d4ed8;
        --ok:#22c55e;
        --err:#ef4444;
        --text:#e5e7eb;
        --muted:#9ca3af;
        --warn:#eab308;
      }
      *{box-sizing:border-box;}
      body{
        margin:0;
        min-height:100vh;
        display:flex;
        justify-content:center;
        background:
          radial-gradient(circle at top,#111827,#020617 55%),
          linear-gradient(135deg,#020617,#000);
        font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
        color:var(--text);
      }
      main{width:100%;max-width:980px;padding:20px 14px 32px;}
      .shell{
        position:relative;
        border-radius:24px;
        border:1px solid rgba(148,163,184,.4);
        background:
          radial-gradient(circle at top left,rgba(37,99,235,.18),transparent 55%),
          radial-gradient(circle at bottom right,rgba(16,185,129,.14),transparent 55%),
          linear-gradient(135deg,rgba(15,23,42,.98),rgba(15,23,42,.99));
        box-shadow:
          0 26px 80px rgba(15,23,42,.9),
          0 0 0 1px rgba(15,23,42,.9) inset;
        padding:20px 18px 22px;
        overflow:hidden;
      }
      header{
        display:flex;
        justify-content:space-between;
        gap:14px;
        align-items:center;
        margin-bottom:16px;
      }
      .brand{display:flex;align-items:center;gap:10px;}
      .logo3d{
        width:42px;height:42px;border-radius:18px;
        background:
          radial-gradient(circle at 30% 0%,#38bdf8,transparent 60%),
          radial-gradient(circle at 80% 90%,#1d4ed8,transparent 40%),
          linear-gradient(145deg,#0f172a,#020617);
        box-shadow:
          0 12px 30px rgba(15,23,42,.95),
          0 0 0 1px rgba(148,163,184,.5),
          0 0 25px rgba(59,130,246,.4);
        display:flex;align-items:center;justify-content:center;
      }
      .logo3d span{font-size:1.1rem;font-weight:700;letter-spacing:.02em;}
      h1{margin:0;font-size:1.45rem;display:flex;align-items:center;gap:6px;}
      .badge{
        font-size:.72rem;padding:3px 9px;border-radius:999px;
        background:rgba(37,99,235,.12);
        border:1px solid rgba(37,99,235,.6);
        color:#bfdbfe;
      }
      .subtitle{margin:2px 0 0;font-size:.8rem;color:var(--muted);}
      .pill{
        font-size:.72rem;padding:7px 12px;border-radius:999px;
        border:1px solid rgba(148,163,184,.5);
        color:var(--muted);
        display:inline-flex;gap:6px;align-items:center;white-space:nowrap;
        backdrop-filter:blur(10px);
        background:rgba(15,23,42,.85);
      }
      .pill-dot{
        width:8px;height:8px;border-radius:999px;
        background:#22c55e;
        box-shadow:0 0 0 5px rgba(34,197,94,.25);
      }
      .grid{
        display:grid;
        grid-template-columns:minmax(0,1.1fr) minmax(0,.9fr);
        gap:14px;
      }
      @media(max-width:820px){
        header{flex-direction:column;align-items:flex-start;}
        .grid{grid-template-columns:minmax(0,1fr);}
      }
      .card{
        border-radius:18px;
        border:1px solid var(--border);
        background:radial-gradient(circle at top right,var(--accent-soft),rgba(15,23,42,.98));
        padding:13px 15px 15px;
      }
      .card.secondary{
        background:
          radial-gradient(circle at top,rgba(37,99,235,.18),transparent 55%),
          radial-gradient(circle at bottom,rgba(15,23,42,.98),#020617);
      }
      .card-title{margin:0;font-size:.95rem;}
      .card-hint{margin:3px 0 7px;font-size:.78rem;color:var(--muted);}
      label{font-size:.78rem;display:block;margin-bottom:4px;}
      input[type="text"]{
        width:100%;
        padding:9px 11px;
        border-radius:11px;
        border:1px solid #1f2937;
        background:rgba(15,23,42,.96);
        color:var(--text);
        font-size:.82rem;
        direction:ltr;
        font-family:ui-monospace,Menlo,Consolas,monospace;
        outline:none;
      }
      input::placeholder{color:#6b7280;}
      input:focus{border-color:var(--accent);box-shadow:0 0 0 1px rgba(59,130,246,.5);}
      .mono{font-family:ui-monospace,Menlo,Consolas,monospace;}
      .muted{color:var(--muted);font-size:.74rem;}
      .row{display:flex;gap:8px;align-items:center;}
      .row.wrap{flex-wrap:wrap;}
      button{
        border-radius:999px;
        padding:9px 15px;
        font-size:.8rem;
        border:0;
        cursor:pointer;
        font-weight:600;
        display:inline-flex;
        align-items:center;
        gap:6px;
        transition:.16s transform ease,.16s box-shadow ease,.16s background ease,.16s opacity ease;
      }
      .btn-primary{
        background:linear-gradient(145deg,var(--accent),var(--accent-strong));
        color:#eff6ff;
        box-shadow:0 10px 35px rgba(37,99,235,.45);
      }
      .btn-primary:hover{transform:translateY(-1px);box-shadow:0 14px 40px rgba(37,99,235,.6);}
      .btn-primary:active{transform:translateY(0);box-shadow:0 8px 25px rgba(37,99,235,.4);}
      .btn-ghost{
        background:transparent;
        border:1px solid rgba(148,163,184,.6);
        color:var(--muted);
      }
      .btn-small{padding:7px 11px;font-size:.76rem;}
      .btn-primary:disabled,.btn-ghost:disabled{opacity:.6;cursor:default;box-shadow:none;transform:none;}
      .status{
        margin-top:6px;
        font-size:.78rem;
        display:flex;
        align-items:center;
        gap:6px;
      }
      .status-dot{width:7px;height:7px;border-radius:999px;background:var(--muted);}
      .status-ok{color:var(--ok);} .status-ok .status-dot{background:var(--ok);}
      .status-err{color:var(--err);} .status-err .status-dot{background:var(--err);}
      .status-pending{color:var(--warn);} .status-pending .status-dot{background:var(--warn);}
      .chip{
        display:inline-flex;
        align-items:center;
        gap:6px;
        padding:4px 9px;
        border-radius:999px;
        border:1px dashed rgba(148,163,184,.7);
        background:rgba(15,23,42,.9);
        font-size:.72rem;
        margin-top:4px;
      }
      .short-box{
        margin-top:10px;
        padding:10px 11px;
        border-radius:13px;
        border:1px solid rgba(34,197,94,.2);
        background:linear-gradient(135deg,rgba(34,197,94,.14),rgba(15,23,42,.98));
      }
      .short-code{font-size:.9rem;font-weight:600;letter-spacing:.05em;}
      .hidden{display:none;}
      .steps{
        margin-top:10px;
        padding-top:8px;
        border-top:1px dashed #1f2937;
        font-size:.73rem;
        color:var(--muted);
      }
      .steps ol{margin:4px 0 0;padding-right:16px;}
      .steps li{margin:2px 0;}
      .price{
        display:flex;align-items:center;gap:10px;margin-top:8px;flex-wrap:wrap;
        padding:10px 12px;border-radius:14px;border:1px solid rgba(148,163,184,.25);
        background:rgba(15,23,42,.75);
      }
      .price strong{font-size:1.05rem;}
      .note{
        margin-top:12px;font-size:.72rem;color:var(--muted);
      }
      .warnbox{
        margin-top:10px;
        padding:10px 11px;
        border-radius:13px;
        border:1px solid rgba(234,179,8,.25);
        background:linear-gradient(135deg,rgba(234,179,8,.10),rgba(15,23,42,.98));
        font-size:.74rem;color:var(--muted);
      }
      .paypal-wrap{
        margin-top:10px;
        padding:12px;
        border-radius:14px;
        border:1px solid rgba(148,163,184,.25);
        background:rgba(15,23,42,.65);
      }
    </style>
  </head>

  <body>
    <main>
      <div class="shell">
        <header>
          <div class="brand">
            <div class="logo3d"><span>PF</span></div>
            <div>
              <h1>PCFixUltimate <span class="badge">ترخيص مدى الحياة</span></h1>
              <p class="subtitle">
                شراء تفعيل أصلي لجهاز واحد + توليد كود تفعيل مخصص لبصمة جهازك.
              </p>
            </div>
          </div>
          <div class="pill">
            <span class="pill-dot"></span>
            <span>دفع آمن عبر PayPal</span>
          </div>
        </header>

        <div class="grid">
          <!-- يسار -->
          <section class="card">
            <h2 class="card-title">الخطوة ١ — إدخال بصمة الجهاز</h2>
            <p class="card-hint">
              افتح هذه الصفحة من داخل البرنامج (يفضّل) أو الصق <span class="mono">mh</span> يدوياً.
            </p>

            <label for="mh_input">بصمة الجهاز (machine hash)</label>
            <div class="row wrap" style="margin-bottom:6px">
              <input id="mh_input" type="text" placeholder="مثال: 81e80f3e97..." />
              <button id="btn_use_mh" type="button" class="btn-primary">
                استخدام هذه البصمة
              </button>
            </div>

            <div class="price">
              <span class="muted">السعر:</span>
              <strong>$1.00</strong>
              <span class="muted">USD — جهاز واحد</span>
              <span class="chip">
                <span>Machine hash:</span>
                <span id="mh" class="mono">—</span>
              </span>
            </div>

            <div id="status" class="status">
              <span class="status-dot"></span>
              <span>أدخل بصمة الجهاز ثم ادفع عبر PayPal.</span>
            </div>

            <div class="paypal-wrap">
              <div class="muted" style="margin-bottom:8px">
                زر الدفع يظهر بعد إدخال بصمة صالحة:
              </div>
              <div id="paypal-buttons"></div>
              <div class="warnbox">
                ملاحظة: إنشاء الطلب/التأكد من الدفع/إصدار الترخيص يتم عبر Worker عندك
                (لأن التحقق من الدفع يحتاج Server و Client Secret).
              </div>
            </div>

            <p class="note">
              إذا فتحت الصفحة من البرنامج، سيتم تمرير <span class="mono">mh</span> تلقائياً في الرابط:
              <span class="mono">buy.html?mh=...</span>
            </p>
          </section>

          <!-- يمين -->
          <section class="card secondary">
            <h2 class="card-title">الخطوة ٢ — استلام كود التفعيل</h2>
            <p class="card-hint">بعد نجاح الدفع سيتم عرض كود التفعيل هنا.</p>

            <div id="license_block" class="hidden">
              <div class="short-box">
                <div style="font-size:.78rem;color:var(--muted);margin-bottom:3px;">
                  الكود القصير لجهازك:
                </div>
                <div class="row">
                  <span id="short_code" class="short-code mono">PCFX-XXXXXXXX</span>
                  <button type="button" id="btn_copy" class="btn-primary btn-small">
                    نسخ الكود
                  </button>
                </div>
              </div>

              <div class="steps">
                <div>طريقة الاستخدام داخل البرنامج:</div>
                <ol>
                  <li>افتح PCFixUltimate واختر <strong>Activate program</strong>.</li>
                  <li>الصق الكود في خانة التفعيل.</li>
                  <li>اضغط تفعيل وستظهر رسالة نجاح.</li>
                </ol>
              </div>
            </div>

            <p id="empty_hint" class="muted">
              لم يتم إنشاء ترخيص بعد. ادفع عبر PayPal ثم سيظهر الكود هنا تلقائياً.
            </p>

            <button type="button" id="btn_clear" class="btn-ghost btn-small" style="margin-top:8px;">
              مسح القيم
            </button>
          </section>
        </div>

        <p class="note">
          الترخيص مرتبط ببصمة جهاز واحد. لتجديد التفعيل بعد الفورمات استخدم نفس <span class="mono">mh</span>.
        </p>
      </div>
    </main>

    <script>
      // Worker endpoints:
      // 1) POST /paypal/create-order  -> { id: "ORDER_ID" }
      // 2) POST /paypal/capture-order -> { ok:true, ... }
      // 3) POST /claim-license       -> { short_code:"PCFX-....", machine_hash:"..." }

      const API_BASE = "https://pcfix-license-api.pcfixultimate.workers.dev";
      const CREATE_ORDER_ENDPOINT = `${API_BASE}/paypal/create-order`;
      const CAPTURE_ORDER_ENDPOINT = `${API_BASE}/paypal/capture-order`;
      const CLAIM_LICENSE_ENDPOINT = `${API_BASE}/claim-license`;

      // ✅ Price for LIVE test
      const PRICE_USD = "1.00";

      const $ = (id) => document.getElementById(id);

      function setStatus(text, mode = "info") {
        const el = $("status");
        el.classList.remove("status-ok","status-err","status-pending");
        if (mode === "ok") el.classList.add("status-ok");
        else if (mode === "err") el.classList.add("status-err");
        else if (mode === "pending") el.classList.add("status-pending");
        el.querySelector(".status-dot").style.opacity = "1";
        el.lastElementChild.textContent = text;
      }

      function mhValue() {
        return ($("mh_input").value || "").trim();
      }

      function isMhValid(mh) {
        return /^[a-f0-9]{32,128}$/i.test(mh);
      }

      function showLicense(code, mh) {
        $("empty_hint").classList.add("hidden");
        $("license_block").classList.remove("hidden");
        $("short_code").textContent = code || "PCFX-XXXXXXXX";
        if (mh) {
          $("mh").textContent = mh;
          if (!$("mh_input").value) $("mh_input").value = mh;
        }
      }

      async function claimLicense(orderId, mh) {
        setStatus("جاري إصدار كود التفعيل…", "pending");
        const res = await fetch(CLAIM_LICENSE_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ order_id: orderId, machine_hash: mh })
        });
        const data = await res.json().catch(()=> ({}));
        if (!res.ok || !data.short_code) {
          throw new Error(data?.error || "تعذر إصدار كود التفعيل. تواصل مع الدعم.");
        }
        showLicense(data.short_code, data.machine_hash || mh);
        setStatus("تم الدفع وإصدار كود التفعيل بنجاح ✓", "ok");
      }

      function renderPaypalButtons() {
        const mh = mhValue();
        if (!isMhValid(mh)) {
          setStatus("أدخل بصمة جهاز صحيحة أولاً لظهور الدفع.", "err");
          return;
        }

        $("mh").textContent = mh;
        $("paypal-buttons").innerHTML = "";

        paypal.Buttons({
          style: { layout: "vertical", label: "paypal" },

          // 1) Create Order on server
          createOrder: async () => {
            setStatus("جاري إنشاء طلب الدفع…", "pending");
            const res = await fetch(CREATE_ORDER_ENDPOINT, {
              method: "POST",
              headers: { "Content-Type":"application/json" },
              body: JSON.stringify({
                machine_hash: mh,
                amount: PRICE_USD,
                currency: "USD"
              })
            });
            const data = await res.json().catch(()=> ({}));
            if (!res.ok || !data.id) {
              throw new Error(data?.error || "تعذر إنشاء طلب PayPal.");
            }
            return data.id;
          },

          // 2) Capture + claim license
          onApprove: async (data) => {
            try {
              setStatus("جاري تأكيد الدفع…", "pending");
              const res = await fetch(CAPTURE_ORDER_ENDPOINT, {
                method: "POST",
                headers: { "Content-Type":"application/json" },
                body: JSON.stringify({ order_id: data.orderID })
              });
              const cap = await res.json().catch(()=> ({}));
              if (!res.ok || !cap.ok) {
                throw new Error(cap?.error || "فشل تأكيد الدفع (Capture).");
              }

              await claimLicense(data.orderID, mh);
            } catch (e) {
              console.error(e);
              setStatus("حصل خطأ بعد الدفع: " + (e?.message || e), "err");
            }
          },

          onCancel: () => setStatus("تم إلغاء عملية الدفع.", "err"),
          onError: (err) => {
            console.error(err);
            setStatus("خطأ في PayPal: " + (err?.message || err), "err");
          }
        }).render("#paypal-buttons");

        setStatus("زر PayPal جاهز — أكمل الدفع.", "ok");
      }

      $("btn_use_mh").addEventListener("click", () => {
        const mh = mhValue();
        if (!isMhValid(mh)) {
          setStatus("البصمة غير صحيحة. الصق قيمة mh كما هي من البرنامج.", "err");
          return;
        }
        $("mh").textContent = mh;
        $("license_block").classList.add("hidden");
        $("empty_hint").classList.remove("hidden");
        renderPaypalButtons();
      });

      $("btn_clear").addEventListener("click", () => {
        $("mh_input").value = "";
        $("mh").textContent = "—";
        $("paypal-buttons").innerHTML = "";
        $("license_block").classList.add("hidden");
        $("empty_hint").classList.remove("hidden");
        setStatus("أدخل بصمة الجهاز ثم ادفع عبر PayPal.", "info");
      });

      $("btn_copy").addEventListener("click", () => {
        const code = $("short_code").textContent || "";
        if (!code) return setStatus("لا يوجد كود لنسخه حالياً.", "err");
        navigator.clipboard.writeText(code)
          .then(() => setStatus("تم نسخ الكود ✓", "ok"))
          .catch((e) => setStatus("تعذر النسخ: " + (e?.message || e), "err"));
      });

      document.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(location.search);
        const mh = params.get("mh") || params.get("machine_hash") || "";
        if (mh) {
          $("mh_input").value = mh;
          $("mh").textContent = mh;
          if (isMhValid(mh)) renderPaypalButtons();
        }
      });
    </script>
  </body>
</html>
