<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>شراء PCFixUltimate — تجربة الدفع الوهمي</title>
<link rel="icon" href="pcfix_icon.ico" />
<style>
  :root{--bg:#f5f7fb;--card:#ffffff;--accent:#0b66ff;--muted:#6b7280}
  body{font-family:system-ui,Segoe UI,Roboto,Arial; background:var(--bg); margin:18px; color:#0b1220; direction:rtl}
  .wrap{max-width:920px;margin:0 auto}
  .card{background:var(--card);border-radius:12px;padding:20px;box-shadow:0 8px 30px rgba(12,20,40,.06)}
  h1{margin:0 0 10px;font-size:20px}
  p.lead{color:var(--muted);margin:0 0 14px}
  label{display:block;margin-top:12px;font-weight:600}
  input[type=text], input[type=email], select, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;margin-top:8px}
  .row{display:flex;gap:12px;margin-top:14px;flex-wrap:wrap}
  button{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .btn-primary{background:var(--accent);color:#fff}
  .btn-ghost{background:#eef3ff;color:var(--accent);border:1px solid rgba(11,102,255,.08)}
  .small{font-size:13px;color:var(--muted)}
  .note{margin-top:12px;color:var(--muted);font-size:13px}
  .flex-between{display:flex;justify-content:space-between;align-items:center;gap:12px}
  pre {background:#0b1220;color:#e6eef8;padding:12px;border-radius:8px;overflow:auto;margin-top:12px}
  .success{background:#ecfdf5;border-left:4px solid #10b981;padding:12px;border-radius:6px;color:#065f46;margin-top:12px}
  .modal {position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.5);z-index:50}
  .modal.show{display:flex}
  .modal-card{background:white;padding:18px;border-radius:10px;max-width:720px;max-height:80vh;overflow:auto}
  .tc{font-size:14px;line-height:1.6;color:#111}
  .actions{display:flex;gap:10px;justify-content:flex-start;margin-top:12px}
  .download-link{display:inline-block;margin-top:10px;background:#f1f5f9;padding:8px;border-radius:8px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="flex-between">
        <div>
          <h1>PCFixUltimate — شراء (تجريبي)</h1>
          <p class="lead">هذا وضع تجريبي: الدفع وهمي. بعد إتمام «الشراء التجريبي» سيُولّد نظامياً رمز تفعيل فعلي (JWT) وتستلم رابط تحميل النسخة الأخيرة.</p>
        </div>
        <div style="text-align:left">
          <img src="pcfix_icon.ico" alt="icon" style="width:64px;height:64px;border-radius:8px"/>
        </div>
      </div>

      <!-- form -->
      <label for="mh">Machine hash (mh) — مطلوب</label>
      <input id="mh" type="text" placeholder="انسخ الـ machine hash هنا أو تأتي من الرابط" />

      <label for="email">بريد المشتري (اختياري)</label>
      <input id="email" type="email" placeholder="example@domain.com" />

      <label for="edition">النسخة</label>
      <select id="edition">
        <option value="single">Single license — ترخيص واحد</option>
        <option value="multi">Team license — ترخيص فريق</option>
      </select>

      <div style="margin-top:12px" class="small">
        السعر هنا تجريبي — لا يتم خصم أي أموال. يمكنك تجربة عملية الدفع ثم استلام رمز التفعيل.
      </div>

      <label style="margin-top:14px">
        <input id="agree" type="checkbox" /> <span style="vertical-align:middle">أوافق على <a href="#" id="show-tc">الشروط والأحكام</a> (مطلوب)</span>
      </label>

      <div class="row">
        <button id="pay" class="btn-primary">دفع تجريبي — إنشاء رمز التفعيل</button>
        <button id="simulate" class="btn-ghost">محاكاة الدفع الناجح</button>
        <button id="open-latest" class="btn-ghost">عرض رابط التحميل الأخير</button>
      </div>

      <div id="status" class="note">الحالة: جاهز.</div>

      <div id="resultArea" style="margin-top:16px;"></div>
    </div>

    <!-- Terms & Conditions modal -->
    <div id="tc-modal" class="modal" role="dialog" aria-modal="true">
      <div class="modal-card">
        <h3>الشروط والأحكام — PCFixUltimate (تجريبي)</h3>
        <div class="tc">
          <p><strong>ملاحظة تجريبية:</strong> هذه نسخة تجريبية لعملية الشراء. لا تدعم عملية الدفع هنا عمليات مالية فعلية.</p>
          <p>باستخدام هذا البرنامج، توافق على: عدم نشر مفتاح الترخيص، الالتزام بشروط الترخيص، وقيود الاستخدام الموضحة أدناه.</p>
          <ul>
            <li>الترخيص الممنوح هو للاستخدام الشخصي/العمل حسب نوع الترخيص.</li>
            <li>يُمنع توزيع الملف التنفيذي أو الترخيص دون إذن صريح.</li>
            <li>لا نتحمل أي أضرار ناجمة عن استخدام البرنامج.</li>
          </ul>
          <p>للاستخدام التجاري أو طلبات دعم خاصة تواصل معنا عبر البريد.</p>
        </div>
        <div class="actions">
          <button id="tc-accept" class="btn-primary">أوافق</button>
          <button id="tc-close" class="btn-ghost">اغلق</button>
        </div>
      </div>
    </div>
  </div>

<script>
/*
  ملف جاهز: عند الضغط على "دفع تجريبي" أو "محاكاة الدفع الناجح" سيتم:
   1) التأكد من وجود mh وcheckbox موافقة الشروط
   2) يستدعي endpoint التوليد (Worker) ليطلب token: POST to LICENSE_WORKER?mh=<mh>
   3) يعرض الـ JWT، تفاصيله المفكَّكة، وزر لتحميل ملف license.json أو نسخه
   4) يقرأ latest.json من موقع الصفحات لتعرض رابط الـ setup الحقيقي للمستخدم
*/

const LICENSE_WORKER = "https://pcfix-license-api.pcfixultimate.workers.dev/generate";
const LATEST_JSON = "https://ameero197-dotcom.github.io/pcfixultimate/latest.json";

const el = id => document.getElementById(id);
const setStatus = s => el('status').textContent = "الحالة: " + s;

function urlParam(name) {
  try {
    const u = new URL(window.location.href);
    return u.searchParams.get(name);
  } catch(e){ return null; }
}

function prettyJson(obj) { return JSON.stringify(obj, null, 2); }

async function fetchLatest() {
  try {
    const r = await fetch(LATEST_JSON + "?t=" + Date.now(), {cache:"no-store"});
    if (!r.ok) throw new Error("لم يتم إيجاد latest.json");
    return await r.json();
  } catch (e) {
    return null;
  }
}

function decodeJwt(token) {
  try {
    const parts = token.split('.');
    if (parts.length < 2) return null;
    const payload = JSON.parse(atob(parts[1].replace(/-/g,'+').replace(/_/g,'/')));
    return payload;
  } catch(e){ return null; }
}

function makeDownloadFile(content, name) {
  const blob = new Blob([content], {type: "application/json;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = name;
  a.click();
  URL.revokeObjectURL(url);
}

// UI: fill mh from querystring if present
const qmh = urlParam('mh');
if (qmh) el('mh').value = qmh;

// Terms modal
el('show-tc').addEventListener('click', (e) => { e.preventDefault(); el('tc-modal').classList.add('show'); });
el('tc-close').addEventListener('click', () => el('tc-modal').classList.remove('show'));
el('tc-accept').addEventListener('click', () => { el('agree').checked = true; el('tc-modal').classList.remove('show'); });

// load latest.json on demand or after success
el('open-latest').addEventListener('click', async () => {
  setStatus("جلب latest.json ...");
  const latest = await fetchLatest();
  if (!latest) { setStatus("فشل جلب latest.json"); return; }
  setStatus("تم جلب latest.json (نسخة " + latest.version + ")");
  const div = el('resultArea');
  div.innerHTML = `
    <div class="card" style="margin-top:12px;padding:12px">
      <div><strong>الإصدار الحالي:</strong> ${latest.version}</div>
      <div style="margin-top:8px"><strong>SHA256:</strong> <code style="font-family:monospace">${latest.sha256}</code></div>
      <div style="margin-top:8px"><a class="download-link" href="${latest.url}" target="_blank" rel="noopener">تحميل النسخة: setup</a></div>
    </div>
  `;
});

// Pay (تجريبي): يتحقق ثم يستدعي الـ worker مباشرة للحصول على token
el('pay').addEventListener('click', async () => {
  const mh = (el('mh').value || '').trim();
  const email = (el('email').value || '').trim();
  const edition = el('edition').value;
  if (!mh) { alert('ادخل قيمة الـ machine hash (mh)'); return; }
  if (!el('agree').checked) { alert('يجب الموافقة على الشروط والأحكام'); return; }

  setStatus("جاري طلب ترخيص من الخادم...");
  try {
    // هنا نستعمل GET أو POST حسب الـ Worker (عندنا /generate?mh=...)
    const url = new URL(LICENSE_WORKER);
    url.searchParams.set('mh', mh);

    const resp = await fetch(url.toString(), {method:'GET', headers:{'User-Agent':'PCFixUltimate-Shop/1.0'}});
    if (!resp.ok) throw new Error('خطأ من الخادم: ' + resp.status);
    const j = await resp.json();
    if (!j.token) throw new Error('الخادم لم يعطِ token');

    displayLicense(j.token, {mh, email, edition});
    setStatus("تم توليد الترخيص بنجاح.");
  } catch (err) {
    console.error(err);
    setStatus("فشل أثناء توليد الترخيص: " + (err.message || err));
    alert("فشل توليد الترخيص — تفقد الكونسول أو رابط الـ Worker.");
  }
});

// Simulate payment: يعمل مثل success callback — يطلب ترخيص أيضاً
el('simulate').addEventListener('click', async () => {
  const mh = (el('mh').value || '').trim();
  if (!mh) { alert('ادخل قيمة الـ machine hash (mh)'); return; }
  if (!el('agree').checked) { alert('يجب الموافقة على الشروط والأحكام'); return; }
  setStatus("محاكاة الدفع — جاري طلب الترخيص...");
  // يمكن هنا أن نمنح بعض التأخير لمحاكاة معالجة الدفع
  await new Promise(r => setTimeout(r, 700));
  // نستدعي نفس مسار pay
  el('pay').click();
});

// عرض الترخيص والخيارات (نسخ/تحميل/فتح رابط التحميل)
async function displayLicense(token, meta = {}) {
  const payload = decodeJwt(token);
  const latest = await fetchLatest(); // لجلب رابط التنصيب الأخير
  const downloadHtml = latest ? `<a class="download-link" href="${latest.url}" target="_blank">تحميل setup الإصدار ${latest.version}</a>` : `<span class="small">latest.json غير متاح</span>`;

  const html = `
    <div class="card" style="margin-top:12px;padding:14px">
      <div class="success"><strong>تم إنشاء الترخيص بنجاح</strong></div>

      <div style="margin-top:12px">
        <strong>License token (JWT)</strong>
        <pre id="jwt">${token}</pre>
        <div style="margin-top:8px" class="row">
          <button id="copy-token" class="btn-ghost">نسخ الترخيص</button>
          <button id="download-token" class="btn-ghost">تحميل ملف الترخيص (license.json)</button>
          <button id="show-payload" class="btn-ghost">عرض بيانات الترخيص</button>
        </div>
      </div>

      <div id="payloadBox" style="display:none;margin-top:12px">
        <strong>تفاصيل الترخيص (payload)</strong>
        <pre id="payloadPre">${payload ? prettyJson(payload) : 'غير قابلة للفك'}</pre>
      </div>

      <div style="margin-top:12px">
        <strong>معلومات إضافية</strong>
        <div class="small">Machine hash: <code style="font-family:monospace">${meta.mh || ''}</code></div>
        ${meta.email ? `<div class="small">Email: ${meta.email}</div>` : ''}
        <div style="margin-top:10px">${downloadHtml}</div>
      </div>
    </div>
  `;
  el('resultArea').innerHTML = html;

  // ربط الأزرار بعد الإدراج
  document.getElementById('copy-token').addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(token);
      alert('تم نسخ الترخيص إلى الحافظة');
    } catch { alert('النسخ فشل — انسخ يدويًا من المربع'); }
  });
  document.getElementById('download-token').addEventListener('click', () => {
    const content = { token, generated_at: new Date().toISOString() };
    makeDownloadFile(JSON.stringify(content, null, 2), 'pcfix_license.json');
  });
  document.getElementById('show-payload').addEventListener('click', () => {
    const box = document.getElementById('payloadBox');
    box.style.display = (box.style.display === 'none') ? 'block' : 'none';
  });
}

// small helper for formatting in template
function prettyJson(obj) { try { return JSON.stringify(obj, null, 2); } catch(e){ return String(obj); } }

</script>
</body>
</html>
