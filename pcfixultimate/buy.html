<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <title>PCFixUltimate — Purchase (Test Mode)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0f16; --panel:#111827; --muted:#6b7280; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --brand:#3b82f6;
      --txt:#e5e7eb; --txt2:#cbd5e1; --card:#0f172a; --border:#1f2937;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b0f16,#0b1120);color:var(--txt);font:16px/1.5 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:940px;margin:40px auto;padding:0 16px}
    .hero{
      background:radial-gradient(1200px 600px at 70% -100px, rgba(59,130,246,.25), transparent),
                 radial-gradient(900px 500px at -10% 120%, rgba(16,185,129,.18), transparent);
      border:1px solid var(--border); border-radius:20px; padding:28px;
      display:flex; align-items:center; gap:18px;
    }
    .logo{font-weight:800;font-size:28px;letter-spacing:.3px}
    .tag{font-size:12px;color:var(--txt2);background:#0b1324;border:1px solid var(--border);padding:4px 10px;border-radius:999px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:18px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:18px}
    h2{margin:0 0 10px 0;font-size:18px}
    .muted{color:var(--muted);font-size:14px}
    .input{display:flex;gap:8px;align-items:center;margin-top:10px}
    input[type=text]{flex:1;background:var(--card);border:1px solid var(--border);border-radius:10px;color:var(--txt);padding:10px 12px}
    button{
      background:var(--brand);border:none;color:white;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer
    }
    button.secondary{background:#1f2937;color:var(--txt2);border:1px solid var(--border)}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    .pill{background:#0b1324;border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-family:ui-monospace,Consolas}
    .flex{display:flex;gap:10px;align-items:center}
    .center{display:flex;align-items:center;justify-content:center}
    .divider{height:1px;background:var(--border);margin:14px 0}
    .footer{margin-top:14px;font-size:12px;color:var(--muted)}
    .copy{font-size:12px;background:#111827;border:1px solid var(--border);color:var(--txt2);padding:6px 10px;border-radius:8px;cursor:pointer}
    .note{background:#0b1324;border:1px dashed #243047;color:var(--txt2);padding:10px 12px;border-radius:10px;font-size:13px}
    .eula{display:flex;align-items:center;gap:10px;margin-top:8px}
    .hidden{display:none}
    .success{
      background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.3);padding:12px;border-radius:12px;color:#d1fae5
    }
    .danger{
      background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.3);padding:12px;border-radius:12px;color:#fee2e2
    }
    @media (max-width: 800px){ .row{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div class="logo">PCFixUltimate</div>
      <span class="tag">Test Checkout (No real payment)</span>
      <div style="flex:1"></div>
      <a class="copy" href="#" id="helpLink">How it works?</a>
    </div>

    <div class="row">
      <div class="card">
        <h2>1) Device Fingerprint</h2>
        <div class="muted">The app passed a machine fingerprint via the URL. If not present, paste it manually.</div>
        <div class="input">
          <input id="mh" type="text" placeholder="machine_hash (from app)" />
          <button class="secondary" id="pasteMH">Paste</button>
        </div>
        <div class="kpi">
          <div class="pill"><b>Status:</b> <span id="mhStatus" class="warn">missing</span></div>
          <div class="pill"><b>Origin:</b> <span id="originHost">—</span></div>
        </div>
        <div class="note" style="margin-top:10px">
          Tip: Normally the app opens this page as:<br/>
          <code>?mh=&lt;machine_hash&gt;&amp;api=https://pcfix-license-api.pcfixultimate.workers.dev/generate</code>
        </div>
      </div>

      <div class="card">
        <h2>2) Test Payment (Fake)</h2>
        <div class="muted">Click the button below to simulate a successful payment. No money is charged.</div>
        <label class="eula">
          <input id="eula" type="checkbox" />
          <span>I agree to the Terms of Use & EULA.</span>
        </label>
        <div class="input">
          <input id="api" type="text" placeholder="Worker /generate endpoint" />
          <button id="pay" disabled>Complete Test Payment</button>
        </div>
        <div id="payMsg" style="margin-top:10px"></div>
      </div>
    </div>

    <div class="card" style="margin-top:18px">
      <h2>3) Your Activation Code</h2>
      <div id="resultBox" class="hidden">
        <div class="success" id="okBox">Payment approved. Your code is ready.</div>
        <div class="divider"></div>
        <div class="flex">
          <div style="min-width:160px">Short (for humans):</div>
          <div class="pill" id="pretty">—</div>
          <button class="copy" id="copyPretty">Copy Pretty</button>
        </div>
        <div class="flex" style="margin-top:10px">
          <div style="min-width:160px">Raw (paste in app):</div>
          <div class="pill" id="raw">—</div>
          <button class="copy" id="copyRaw">Copy Raw</button>
        </div>
        <div class="divider"></div>
        <div class="note">
          In PCFixUltimate → Activate: paste the <b>Raw</b> code if you want the app to auto-exchange it for a license.
          Your app also supports pasting the full JWT if you use the API directly.
        </div>
      </div>
      <div id="errBox" class="hidden danger" style="margin-top:8px"></div>
    </div>

    <div class="footer">
      © PCFixUltimate • Test mode • This page calls your Worker to generate codes; no real payment is processed.
    </div>
  </div>

  <script>
    const q = new URLSearchParams(location.search);
    const byId = (x)=>document.getElementById(x);
    const mhInput = byId('mh');
    const apiInput = byId('api');
    const payBtn = byId('pay');
    const eula = byId('eula');
    const payMsg = byId('payMsg');
    const prettyEl = byId('pretty');
    const rawEl = byId('raw');
    const resultBox = byId('resultBox');
    const errBox = byId('errBox');
    const mhStatus = byId('mhStatus');
    const originHost = byId('originHost');

    originHost.textContent = location.host || '—';

    // Prefill from query (?mh=...&api=...)
    const mhQ = q.get('mh') || q.get('machine_hash') || '';
    const apiQ = q.get('api') || 'https://pcfix-license-api.pcfixultimate.workers.dev/generate';
    mhInput.value = mhQ;
    apiInput.value = apiQ;
    mhStatus.textContent = mhInput.value ? 'ok' : 'missing';
    mhStatus.className = mhInput.value ? 'ok' : 'warn';

    // Enable pay button when EULA + MH present
    function refreshPayState(){
      payBtn.disabled = !(eula.checked && mhInput.value.trim() && apiInput.value.trim());
    }
    eula.addEventListener('change', refreshPayState);
    mhInput.addEventListener('input', ()=>{
      mhStatus.textContent = mhInput.value ? 'ok' : 'missing';
      mhStatus.className = mhInput.value ? 'ok' : 'warn';
      refreshPayState();
    });
    apiInput.addEventListener('input', refreshPayState);
    refreshPayState();

    byId('pasteMH').addEventListener('click', async ()=>{
      try{
        const t = await navigator.clipboard.readText();
        if(t){
          mhInput.value = t.trim();
          mhStatus.textContent = 'ok';
          mhStatus.className = 'ok';
          refreshPayState();
        }
      }catch{}
    });

    byId('helpLink').addEventListener('click', (e)=>{
      e.preventDefault();
      alert(
`How it works (TEST):
• This page simulates a successful payment.
• On success, it calls your Worker /generate with the device fingerprint (mh).
• The Worker returns:
  - activation_code_pretty: short human-friendly code
  - activation_code: raw code (license_id.signature)
  - token: full JWT (not needed for users)
• Paste the RAW code into PCFixUltimate → Activate. The app exchanges it to a license automatically.`
      );
    });

    async function callGenerate(api, mh){
      // Accept GET or POST (your Worker supports both)
      // We'll use POST to avoid query logging.
      const url = api;
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ mh })
      });
      if(!res.ok){
        const txt = await res.text().catch(()=>res.statusText);
        throw new Error(`API ${res.status} ${txt}`);
      }
      return res.json();
    }

    function showError(msg){
      errBox.textContent = msg;
      errBox.classList.remove('hidden');
      resultBox.classList.add('hidden');
      payMsg.innerHTML = '';
    }
    function showResult(pretty, raw){
      prettyEl.textContent = pretty || '—';
      rawEl.textContent = raw || '—';
      errBox.classList.add('hidden');
      resultBox.classList.remove('hidden');
      payMsg.innerHTML = '<span class="ok">✔ Simulated payment succeeded.</span>';
    }

    payBtn.addEventListener('click', async ()=>{
      payBtn.disabled = true;
      payMsg.innerHTML = '<span class="muted">Processing test payment…</span>';
      errBox.classList.add('hidden');
      resultBox.classList.add('hidden');
      try{
        const api = apiInput.value.trim();
        const mh  = mhInput.value.trim();
        if(!api || !mh){ showError('Missing API or machine_hash.'); return; }
        const data = await callGenerate(api, mh);
        // Expect: { token, activation_code, activation_code_pretty }
        if(!data.activation_code || !data.activation_code_pretty){
          showError('Invalid response. Ensure your Worker returned activation_code fields.');
          return;
        }
        showResult(data.activation_code_pretty, data.activation_code);
      }catch(err){
        showError(err.message || String(err));
      }finally{
        payBtn.disabled = !(eula.checked && mhInput.value.trim() && apiInput.value.trim());
      }
    });

    function copyText(t){
      try{ navigator.clipboard.writeText(t); }catch{}
    }
    byId('copyPretty').addEventListener('click', ()=> copyText(prettyEl.textContent));
    byId('copyRaw').addEventListener('click', ()=> copyText(rawEl.textContent));
  </script>
</body>
</html>
