<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PCFixUltimate — Buy / Demo</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;line-height:1.5;margin:24px;background:#f7f8fa;color:#111}
    .card{max-width:820px;margin:0 auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 6px 18px rgba(20,20,30,0.06)}
    h1{margin:0 0 8px;font-size:22px}
    p.lead{color:#4b5563;margin:0 0 16px}
    label{display:block;margin-top:12px;font-weight:600}
    input[type="text"]{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;margin-top:6px}
    .row{display:flex;gap:12px;margin-top:18px;flex-wrap:wrap}
    button{padding:10px 16px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
    .btn-primary{background:#0b66ff;color:#fff}
    .btn-ghost{background:#eef2ff;color:#0b66ff}
    .btn-danger{background:#ef4444;color:#fff}
    .note{font-size:13px;color:#6b7280;margin-top:12px}
    pre { background:#0f172a;color:#e6eef8;padding:12px;border-radius:8px;overflow:auto }
    .small{font-size:13px;color:#6b7280}
  </style>
</head>
<body>
  <div class="card">
    <h1>PCFixUltimate — Purchase / Test</h1>
    <p class="lead">Use the form below to simulate a purchase or (if configured) start a real checkout. For testing, click <strong>Simulate successful payment</strong>.</p>

    <!-- MACHINE HASH -->
    <label for="mh">Machine hash (mh)</label>
    <input id="mh" type="text" placeholder="paste machine hash (mh) here" />

    <!-- Hidden: endpoint used by thanks.html to request license token from worker -->
    <label for="api" class="small">License API (used by thanks page)</label>
    <input id="api" type="text" placeholder="https://pcfix-license-api.pcfixultimate.workers.dev/generate" />

    <div class="row">
      <!-- Real checkout button (will attempt to call a checkout worker) -->
      <button id="pay-btn" class="btn-primary" title="Start real checkout (worker must be configured)">
        Pay with Stripe (real checkout)
      </button>

      <!-- Simulate successful payment: redirects to thanks page like Stripe success -->
      <button id="simulate-success" class="btn-ghost" title="Simulate a successful payment and open the thanks page">
        Simulate successful payment
      </button>

      <!-- Quick open thanks (useful for repeated testing if you only want to open thanks page) -->
      <button id="open-thanks" class="btn-danger" title="Open thanks page (no payment) for debug">
        Open thanks page (debug)
      </button>
    </div>

    <p class="note">
      Tips:
      <ul>
        <li>If you already have a machine hash in URL, the field will be filled automatically.</li>
        <li>The simulate button will redirect to <code>thanks.html?mh=...&session_id=simulated</code> so the license-generation flow runs without real payment.</li>
      </ul>
    </p>

    <hr style="margin:18px 0">

    <h2 style="font-size:16px;margin-bottom:6px">Developer / Debug</h2>
    <p class="small">Response from the license worker (for the simulated flow) will appear on the <code>thanks.html</code> page. Use that page to confirm the JWT/token is generated.</p>

    <pre id="info">Ready — enter mh and click a button.</pre>
  </div>

  <script>
    // --- Configuration (edit only if you want to enable real checkout) ---
    const CHECKOUT_WORKER = ""; // e.g. https://pcfix-stripe-checkout.YOUR_SUBDOMAIN.workers.dev/create-session
    const STRIPE_PK = ""; // optional (not required for simulation)

    // --- Helpers ---
    function qsParam(name, url = window.location.href) {
      try {
        const u = new URL(url);
        return u.searchParams.get(name);
      } catch(e) { return null; }
    }

    function setInfo(text) { document.getElementById('info').textContent = text; }

    // Fill fields from querystring if present
    (function initFill() {
      const mhQ = qsParam('mh');
      const apiQ = qsParam('api');
      if (mhQ) document.getElementById('mh').value = mhQ;
      if (apiQ) document.getElementById('api').value = apiQ;
    })();

    // Pay (real checkout) - only works if CHECKOUT_WORKER is configured and expects POST { mh, return_url }
    document.getElementById('pay-btn').addEventListener('click', async () => {
      const mh = (document.getElementById('mh').value || '').trim();
      const api = (document.getElementById('api').value || '').trim();
      if (!mh) { alert('Please enter machine hash (mh)'); return; }
      if (!CHECKOUT_WORKER) { alert('Real checkout not configured. Use the "Simulate" button for testing.'); return; }

      setInfo('Starting real checkout (requesting session from worker)...');
      try {
        const resp = await fetch(CHECKOUT_WORKER, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ mh, return_url: `${location.origin}/pcfixultimate/thanks.html` })
        });
        if (!resp.ok) throw new Error('Checkout worker returned ' + resp.status);
        const j = await resp.json();
        if (j.url) {
          // redirect to Stripe Checkout
          window.location.href = j.url;
        } else {
          throw new Error('Invalid response from checkout worker: ' + JSON.stringify(j));
        }
      } catch (err) {
        setInfo('Checkout error: ' + err);
        alert('Checkout failed — check console/info.');
        console.error(err);
      }
    });

    // Simulate: redirect to thanks.html as if Stripe returned to success_url with session_id
    document.getElementById('simulate-success').addEventListener('click', () => {
      const mh = (document.getElementById('mh').value || '').trim();
      const api = (document.getElementById('api').value || '').trim();
      if (!mh) { alert('Enter machine hash first'); return; }

      // build the URL just like a real success redirect
      const redirect = `${location.origin}/pcfixultimate/thanks.html?mh=${encodeURIComponent(mh)}&session_id=simulated&api=${encodeURIComponent(api)}`;
      setInfo('Redirecting to: ' + redirect);
      window.location.href = redirect;
    });

    // Quick open thanks page (no payment/session)
    document.getElementById('open-thanks').addEventListener('click', () => {
      const mh = (document.getElementById('mh').value || '').trim();
      const api = (document.getElementById('api').value || '').trim();
      if (!mh) { alert('Enter machine hash first'); return; }
      const redirect = `${location.origin}/pcfixultimate/thanks.html?mh=${encodeURIComponent(mh)}&session_id=debug&api=${encodeURIComponent(api)}`;
      window.open(redirect, '_blank');
    });

  </script>
</body>
</html>
