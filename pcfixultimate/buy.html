<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <title>PCFixUltimate — تفعيل وتحميل آخر إصدار</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root{
        --bg:#020617;--card:#020617;--border:#1f2937;
        --accent:#2563eb;--accent-soft:rgba(37,99,235,.18);
        --ok:#22c55e;--err:#ef4444;--text:#e5e7eb;--muted:#9ca3af;
      }
      *{box-sizing:border-box;}
      body{
        margin:0;background:radial-gradient(circle at top,#111827,#020617);
        font-family:system-ui,-apple-system,"Segoe UI",sans-serif;
        color:var(--text);display:flex;justify-content:center;min-height:100vh;
      }
      main{width:100%;max-width:960px;padding:18px 12px 32px;}
      .shell{
        border-radius:22px;border:1px solid rgba(148,163,184,.4);
        background:linear-gradient(135deg,rgba(15,23,42,.96),rgba(15,23,42,.99));
        box-shadow:0 24px 60px rgba(15,23,42,.8);
        padding:18px 18px 22px;
      }
      header{display:flex;justify-content:space-between;gap:12px;align-items:center;margin-bottom:14px;}
      h1{margin:0;font-size:1.3rem;display:flex;align-items:center;gap:8px;}
      .badge{font-size:.7rem;padding:3px 8px;border-radius:999px;
        background:rgba(37,99,235,.1);border:1px solid rgba(37,99,235,.5);color:#bfdbfe;}
      .subtitle{margin:2px 0 0;font-size:.78rem;color:var(--muted);}
      .pill{font-size:.72rem;padding:6px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.5);
        color:var(--muted);display:inline-flex;gap:6px;align-items:center;white-space:nowrap;}
      .pill-dot{width:7px;height:7px;border-radius:999px;background:#22c55e;box-shadow:0 0 0 4px rgba(34,197,94,.25);}
      .grid{display:grid;grid-template-columns:minmax(0,1.1fr) minmax(0,.9fr);gap:14px;}
      @media(max-width:780px){
        .grid{grid-template-columns:minmax(0,1fr);}
        header{flex-direction:column;align-items:flex-start;}
      }
      .card{border-radius:18px;border:1px solid var(--border);background:radial-gradient(circle at top right,var(--accent-soft),#020617);padding:12px 14px 14px;}
      .card.secondary{background:radial-gradient(circle at top,rgba(15,23,42,.94),#020617);}
      .card-title{margin:0;font-size:.9rem;}
      .card-hint{margin:2px 0 6px;font-size:.76rem;color:var(--muted);}
      label{font-size:.78rem;display:block;margin-bottom:4px;}
      input[type="text"]{
        width:100%;padding:9px 11px;border-radius:10px;border:1px solid #1f2937;
        background:rgba(15,23,42,.96);color:var(--text);font-size:.82rem;direction:ltr;
        font-family:ui-monospace,Menlo,Consolas,monospace;outline:none;
      }
      input::placeholder{color:#6b7280;}
      input:focus{border-color:var(--accent);box-shadow:0 0 0 1px rgba(59,130,246,.5);}
      .row{display:flex;gap:8px;align-items:center;}
      .row.wrap{flex-wrap:wrap;}
      button{
        border-radius:999px;padding:8px 14px;font-size:.8rem;border:0;cursor:pointer;
        font-weight:600;display:inline-flex;align-items:center;gap:6px;
      }
      .btn-primary{background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#eff6ff;}
      .btn-ghost{background:transparent;border:1px solid rgba(148,163,184,.6);color:var(--muted);}
      .btn-small{padding:7px 10px;font-size:.76rem;}
      .btn-primary:disabled{opacity:.6;cursor:default;}
      .muted{color:var(--muted);font-size:.74rem;}
      .mono{font-family:ui-monospace,Menlo,Consolas,monospace;}
      .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;
        border:1px dashed rgba(148,163,184,.7);background:rgba(15,23,42,.9);font-size:.72rem;}
      .status{margin-top:5px;font-size:.78rem;}
      .status-ok{color:var(--ok);} .status-err{color:var(--err);} .status-pending{color:#eab308;}
      .hidden{display:none;}
      .download-card{margin-top:14px;padding-top:10px;border-top:1px dashed #1f2937;
        display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;}
      .download-meta{font-size:.76rem;color:var(--muted);}
      .tag{font-size:.7rem;padding:3px 7px;border-radius:999px;border:1px solid rgba(148,163,184,.5);color:var(--muted);}
      .short-display{
        margin-top:10px;padding:10px 12px;border-radius:14px;
        border:1px solid rgba(148,163,184,.6);background:rgba(15,23,42,.9);
        display:flex;flex-direction:column;gap:6px;
      }
      .short-code{
        font-size:1rem;font-weight:600;letter-spacing:.08em;
        text-align:center;direction:ltr;
      }
    </style>
  </head>
  <body>
    <main>
      <div class="shell">
        <header>
          <div>
            <h1>PCFixUltimate <span class="badge">تفعيل + تحميل</span></h1>
            <p class="subtitle">
              توليد كود التفعيل القصير المرتبط بجهازك، مع رابط تحميل آخر إصدار من البرنامج.
            </p>
          </div>
          <div class="pill">
            <span class="pill-dot"></span>
            <span>الاتصال آمن وموقَّع رقمياً</span>
          </div>
        </header>

        <div class="grid">
          <!-- يسار: machine hash + التحديث -->
          <section class="card">
            <h2 class="card-title">خطوة ١ — اختيار الجهاز</h2>
            <p class="card-hint">
              افتح هذه الصفحة من داخل البرنامج (يفضَّل)، أو الصق الـ
              <span class="mono">machine hash</span> يدويًا.
            </p>

            <form id="form" autocomplete="off">
              <label for="mh_input">بصمة الجهاز (machine hash)</label>
              <div class="row wrap" style="margin-bottom:8px">
                <input id="mh_input" type="text" placeholder="مثال: 81e80f3e97...">
                <button id="btn_generate" type="submit" class="btn-primary">
                  <span id="btn_text">توليد كود التفعيل</span>
                  <span id="btn_spinner" class="hidden">⏳</span>
                </button>
              </div>
              <p class="muted">
                إذا فتحت الصفحة من البرنامج سيتم تمرير
                <span class="mono">mh</span> تلقائياً في الرابط.
              </p>

              <div style="margin-top:8px">
                <div class="chip">
                  <span>Machine hash:</span>
                  <span id="mh" class="mono">—</span>
                </div>
                <div id="status" class="status muted">جاهز</div>
              </div>
            </form>

            <!-- كرت التحديث والتحميل -->
            <div class="download-card">
              <div class="download-meta">
                <div>آخر إصدار متوفر: <span id="latest_version" class="mono">—</span></div>
                <div style="margin-top:2px">
                  <span class="tag">SHA-256</span>
                  <span id="latest_sha" class="mono" style="font-size:.68rem;">—</span>
                </div>
              </div>
              <button id="btn_download" class="btn-ghost btn-small" disabled>
                تحميل آخر إصدار
              </button>
            </div>
            <p id="latest_status" class="muted" style="margin-top:4px;">
              جارٍ التحقق من الإصدار الأخير…
            </p>
          </section>

          <!-- يمين: الكود القصير فقط -->
          <section class="card secondary">
            <h2 class="card-title">خطوة ٢ — نسخ كود التفعيل القصير</h2>
            <p class="card-hint">
              انسخ الكود القصير والصقه داخل برنامج PCFixUltimate في نافذة التفعيل.
            </p>

            <div id="result_short" class="short-display hidden">
              <span class="muted">الكود القصير المرتبط بهذا الجهاز:</span>
              <div class="short-code mono" id="short_display">PCFX-XXXX-XXXX</div>
              <div class="row" style="margin-top:6px;">
                <input id="short" type="text" readonly>
                <button type="button" class="btn-primary btn-small" onclick="copyField('short')">
                  نسخ الكود
                </button>
              </div>
              <p class="muted">
                يبدأ بـ <span class="mono">PCFX-</span> ويُستخدم مباشرة داخل البرنامج.
              </p>
            </div>

            <p id="empty_hint" class="muted">
              لم يتم إنشاء كود بعد. أدخل
              <span class="mono">machine hash</span> ثم اضغط «توليد كود التفعيل».
            </p>

            <button type="button" id="btn_clear" class="btn-ghost btn-small" style="margin-top:6px;">
              مسح القيم
            </button>
          </section>
        </div>

        <p class="muted" style="margin-top:12px;font-size:.72rem;">
          ملاحظة: الكود مرتبط ببصمة جهاز واحد. لإعادة التفعيل بعد الفورمات استخدم نفس
          <span class="mono">machine hash</span>.
        </p>
      </div>
    </main>

    <script>
      const API = "https://pcfix-license-api.pcfixultimate.workers.dev";
      const LATEST_URL =
        "https://raw.githubusercontent.com/ameero197-dotcom/ameero197-dotcom.github.io/main/pcfixultimate/latest.json";

      const $ = (id) => document.getElementById(id);

      function setStatus(text, mode = "info") {
        const el = $("status");
        el.textContent = text;
        el.classList.remove("status-ok", "status-err", "status-pending");
        if (mode === "ok") el.classList.add("status-ok");
        else if (mode === "err") el.classList.add("status-err");
        else if (mode === "pending") el.classList.add("status-pending");
      }

      function setLoading(isLoading) {
        $("btn_generate").disabled = isLoading;
        $("btn_spinner").classList.toggle("hidden", !isLoading);
        $("btn_text").textContent = isLoading ? "جاري التوليد..." : "توليد كود التفعيل";
      }

      async function generateFor(mh) {
        $("mh").textContent = mh || "—";
        $("empty_hint").classList.add("hidden");
        $("result_short").classList.add("hidden");

        if (!mh) {
          setStatus("يرجى إدخال machine hash صالح.", "err");
          return;
        }

        setLoading(true);
        setStatus("جاري الاتصال بالخادم وتوليد الكود...", "pending");

        try {
          const res = await fetch(`${API}/generate?mh=${encodeURIComponent(mh)}`);
          const data = await res.json();
          if (!res.ok) throw new Error(data?.error || res.statusText || "Unknown error");

          const shortCode = data.short_code || "";
          if (!shortCode) {
            throw new Error("الخادم لم يرجع كود قصير.");
          }

          $("short").value = shortCode;
          $("short_display").textContent = shortCode;

          $("result_short").classList.remove("hidden");
          setStatus("تم توليد كود التفعيل بنجاح ✓", "ok");
        } catch (err) {
          $("result_short").classList.add("hidden");
          $("empty_hint").classList.remove("hidden");
          setStatus("خطأ أثناء التوليد: " + (err?.message || err), "err");
        } finally {
          setLoading(false);
        }
      }

      function copyField(id) {
        const el = $(id);
        if (!el) return;
        const value = el.value || "";
        if (!value) {
          setStatus("لا يوجد نص لنسخه.", "err");
          return;
        }
        navigator.clipboard
          .writeText(value)
          .then(() => setStatus("تم نسخ الكود بنجاح ✓", "ok"))
          .catch((err) => setStatus("تعذّر النسخ: " + (err?.message || err), "err"));
      }

      async function loadLatest() {
        const vs = $("latest_status");
        try {
          vs.textContent = "جارٍ التحقق من الإصدار الأخير…";
          const res = await fetch(LATEST_URL, { cache: "no-store" });
          if (!res.ok) throw new Error(res.statusText || "HTTP " + res.status);
          const data = await res.json();
          const ver = data.version || "غير معروف";
          const url = data.url || "#";
          const sha = data.sha256 || "—";

          $("latest_version").textContent = ver;
          $("latest_sha").textContent = sha;
          const btn = $("btn_download");
          btn.disabled = !url || url === "#";
          btn.onclick = () => { if (url && url !== "#") window.open(url, "_blank"); };
          vs.textContent = "تم جلب معلومات آخر إصدار بنجاح.";
        } catch (err) {
          vs.textContent = "تعذّر جلب معلومات آخر إصدار: " + (err?.message || err);
          $("btn_download").disabled = true;
        }
      }

      $("btn_clear").addEventListener("click", () => {
        $("mh_input").value = "";
        $("mh").textContent = "—";
        $("short").value = "";
        $("short_display").textContent = "PCFX-XXXX-XXXX";
        $("result_short").classList.add("hidden");
        $("empty_hint").classList.remove("hidden");
        setStatus("جاهز");
      });

      document.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(location.search);
        const mh = params.get("mh") || params.get("machine_hash") || "";
        if (mh) {
          $("mh_input").value = mh;
          generateFor(mh);
        }
        $("form").addEventListener("submit", (e) => {
          e.preventDefault();
          const input = $("mh_input").value.trim();
          generateFor(input);
        });
        loadLatest();
      });
    </script>
  </body>
</html>
